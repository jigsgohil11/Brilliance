@model Brilliance.Models.Entity.TCFForm
@using Brilliance.Infrastructure.DataProvider;
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout_public.cshtml";
    ConductDataprovider _icisDataProvider = new ConductDataprovider();
}

<link href="~/Content/kendoStyles.css" rel="stylesheet" />




<style>
    #grid {
        margin: 0;
        padding: 0;
        border-width: 0;
        height: 100%;
        /* DO NOT USE !important for setting the Grid height! */
    }
     #selectedFiles img {
        max-width: 200px;
        max-height: 200px;
        float: left;
        margin-bottom: 10px;
    }
</style>

    <div class="page-content page-content-dashbrd-backgrnd">
        <div class="page-bar margin-bottom-10">
            <div class="row">
                <div class="col-md-12 padding-out">
                    <div class="portlet light padding-header margin-0 custom-padding-bar">
                        <div class="portlet-title portlet-title-Project-custom">
                            <div class="caption font-dark">
                                <i class="icon-settings font-dark"></i>
                                <span class="caption-subject bold uppercase">Conduct Improvement System</span>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <br />
        <!-- Button trigger modal -->
        <!-- Button trigger modal -->
        <button type="button" class="btn btn-brilliance btn-sm" data-toggle="modal" data-target="#exampleModalLong">
            Add own TCF requirement
        </button>
        <form id="frmtcf" action="/CIS/Index" method="post" data-ajax="true" data-ajax-method="Post" enctype="multipart/form-data" data-ajax-success="SaveTCFResponse(data);">
            @Html.HiddenFor(x=>x.Id)
            <!-- Modal -->

            <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Capture...</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true" class="table table-responsive table-condensed">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="form-group">
                                    <div class="col-md-12">
                                       
                                        <label>Select the outcome for this TCF requirement</label>
                                        @Html.DropDownListFor(x => x.TCFOutCome.TCFQuestionGroupId, _icisDataProvider.BindOutcome(), "...", new { @class = "form-control", @style = "width:47%;" })
                                    </div>

                                </div>
                            </div>
                            <br />
                            <div class="row">
                                <div class="form-group">
                                    <div class="col-md-12">
                                        <label>Provide the description</label>
                                        <br />
                                        @Html.TextAreaFor(x => x.Description, new { @class = "form-control", @style = "width:100%;" })


                                    </div>

                                </div>
                            </div>
                            <br />


                            <div class="modal-footer">
                                <button type="submit" class="btn btn-brilliance">Save and Close</button>
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        
            <!--EDIT MODAL-->
        
        

            <div class="modal fade" id="EditModal" tabindex="-1" role="dialog" aria-labelledby="EditModal" aria-hidden="true">

                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLongTitle">Capture...</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="form-group">
                                    <div class="col-md-12">
                                        <label id="txtdesnum"></label>
                                        <br />
                                        <label id="txtdes" style="color: #BA1800;font-weight:bold;"></label>
                                       
                                        @Html.HiddenFor(x => x.TCFOutCome.TCFSubOutCome.IsEdit)
                                        @Html.HiddenFor(x => x.TCFOutCome.TCFSubOutCome.Id)
                                        @Html.HiddenFor(x => x.TCFOutCome.TCFSubOutCome.TCFQuestionId)
                                    </div>

                                </div>
                            </div>

                            <br />

                            <div class="row">
                                <div class="form-group">
                                    <div class="col-md-12">
                                        <label>Rate the extent to which this is in place or in practice</label>
                                        @Html.DropDownListFor(x => x.TCFOutCome.TCFSubOutCome.RateId, _icisDataProvider.BindOutcomeRating(), "...", new { @class = "form-control", @style = "width:47%;" })
                                    </div>

                                </div>
                            </div>

                            <br />
                            <div class="row" id="notapply">
                                <div class="form-group">
                                    <div class="col-md-12">
                                        <label>Why do you say this is not applicable?</label>
                                        <br />
                                        @Html.TextAreaFor(x => x.TCFOutCome.TCFSubOutCome.ReasonNotApplicable, new { @class = "form-control", @style = "width:100%;", @placeholder = "Please carefully consider whether this is something that should be in place, albeit not yet, before you declare it not applicable." })

                                    </div>
                                </div>
                            </div>
                            <br />
                            <div id="notyet">
                                <div class="row">
                                    <div class="form-group">
                                        <div class="col-md-12">
                                            <label>Notes</label>
                                            <br />

                                            @Html.TextAreaFor(x => x.TCFOutCome.TCFSubOutCome.ReasonPartially, new { @class = "form-control", @style = "width:100%;", @placeholder = "Type here what has been and/or needs to be done towards closing this gap. Note: This field is optional.  Whatever you insert here will be included in the email that automatically gets sent to the responsible person if that person is not yourself." })

                                        </div>
                                    </div>
                                    <br />


                                </div>

                                <div class="row" id="divdate">
                                    <div class="form-group">
                                        <div class="col-md-12">
                                            <label>Due date by when this will be in place or in practice</label>
                                            <br />
                                            @Html.TextBoxFor(x => x.TCFOutCome.TCFSubOutCome.DueDate, new { @class = "form-control", @style = "width:47%;" })

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br />
                            <div id="divfully">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label>Why do you say this is fully in place or in practice?</label>
                                            @Html.TextAreaFor(x => x.TCFOutCome.TCFSubOutCome.ReasonFully, new { @class = "form-control", @width = "100%" })
                                        </div>
                                    </div>

                                </div>
                                <br />
                                <div class="row">
                                    <div class="col-md-12">

                                        <div class="form-group">
                                            <label>Provide evidence proving this is fully in place or in practice </label>
                                            <div id="selectedFiles"></div>
                                            <input type="file" name="images[]"  id="files" multiple/>
                                            <div id="selectedFiles"></div>
                                            @*@Html.Partial("_UploadFile")*@
                                        </div>
                                    </div>

                                </div>
                                <br />
                            </div>
                            <br />
                            <div class="row" id="dvres">

                                <div class="form-group">
                                    <div class="col-md-12">
                                        <label>Who is responsible for getting and / or keeping this in place or in practice?</label>
                                        <br />
                                        @Html.DropDownListFor(x => x.TCFOutCome.TCFSubOutCome.TCFSubOutComeUserId, _icisDataProvider.BindUsers(), "...", new { @class = "form-control", @style = "width:100%;" })


                                    </div>
                                </div>
                                <div class="form-group" id="reguser">
                                    <div class="col-md-12">
                                        @*@Html.Partial("_TCFRegisterUser")*@


                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <span style="padding-left: 2%;font-weight:bold;">Notes:</span>&nbsp;<span>Optional add note</span>
                                    &nbsp;&nbsp;&nbsp;
                                    <button type="button" class="btnaddnote"><img src="~/Images/iconfinder_add_green_619545.png" width="20"></button>
                                    <button type="button" class="btn-default addn"><img src="~/Images/iconfinder_add_green_619545.png" width="20"></button>
                                </div>
                                <div class="row" id="divadd" style="display:none;width: 100%;">
                                    <div class="form-group">

                                        <div class="col-md-12">
                                            <div>
                                                @Html.Partial("TCFNote")
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br />
                            <div class="row">
                                <div class="form-group">
                                    <span style="padding-left: 2%;font-weight:bold;">Notes:</span>&nbsp;<span>Optional add task</span>
                                    &nbsp;&nbsp;&nbsp;
                                    <button type="button" class="addtask"> <img src="~/Images/iconfinder_add_green_619545.png" width="20"></button>
                                    <button type="button" class="addt"> <img src="~/Images/iconfinder_add_green_619545.png" width="20"></button>

                                </div>
                            </div>

                            <br />
                            <div class="row" id="divtsk">
                                <div class="form-group">

                                    <div class="col-md-12">
                                        <div style="display:block;width: 100%;">
                                            @Html.Partial("TCFTask")
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="modal-footer">
                                <button type="button" class="btn btn-brilliance btnupdate">Save and Close</button>
                                <button type="button" class="btn btn-default btclose" data-dismiss="modal">Close</button>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </form>
            <div class="row">
                <div id="grid"></div>
            </div>

</div>




@section scripts{
    @*<script src="~/Scripts/knockout.js"></script>*@
    <script src="~/Scripts/jszip.min.js"></script>
    <script src="~/Scripts/kendo.all.min.js"></script>
<script src="~/Scripts/multifieldwrapperFileUpload.js"></script>

    @*<script src="~/Scripts/multifieldwrapper.js"></script>*@
<script src="~/Scripts/multifieldwrapperNote.js"></script>
<script src="~/Scripts/multifieldwrapperTask.js"></script>
    <script>
        var selDiv = "";
        var storedFiles = [];
        var data = new FormData();
        var table = $("<table class='table table-responsive table-condensed' id='tblimage'></table>")
        $(document).ready(function () {

            var url = '@Url.Action("CisQuestion", "CIS")';

            var element = $("#grid").kendoGrid({
                dataSource: {

                    transport: {
                        read: {
                            url: url,
                            type: "get",
                            dataType: "json"
                        }
                    },
                    group: { field: "Description", aggregates: [{ field: "Description", aggregate: "count" }, { field: "Status", aggregate: "sum" }] },
                    groupable: false,
                    sortable: false,
                    pageSize: 1000,
                    serverPaging: false,
                    serverSorting: false
                },

                sortable: false,
                pageable: false,
                scrollable: true,
                /// detailInit: detailInit,
                dataBound: function () {
                    var grid = this;
                    $(".k-grouping-row").each(function (e) {
                        grid.collapseGroup(this);
                    });
                    ////this.expandRow(this.tbody.find("tr.k-master-row").last());
                },


                columns: [
                    {
                        title: "Ref",
                        field: "Qgroup",

                        width: "4%"
                    },
                    {
                        field: "Qdesc",
                        title: "Description",
                        width: "55%"
                    },
                    {
                        title: "Previous Rating",
                        width: "110px"
                    },
                    {
                        field: "CurrentRating",
                        title: "Current Rating",
                        width: "110px"
                    },
                    {
                        title: "Current Due Dates",
                        width: "140px"
                    },
                    {


                        'title': 'Edit',
                        'field': 'Edit',
                        template: "<a href='\\\#' class='sub-link btn btn-default' value='#= TCFSubOutComeId #'>#= 'Edit' #</a>"
                    },
                     {
                         field: "Description",
                         hidden: true,
                         groupHeaderTemplate: "#= customFunction(value,aggregates.Status)#"
                     }
                ]

            }).on("click", "a.sub-link", function () {
                var tr = $(this).closest("tr");

                var dataItem = $("#grid").data("kendoGrid").dataItem(tr);
                var id = dataItem.TCFSubOutComeId;
                
                $('#EditModal').modal('show');

                var url = '@Url.Action("_GetSuboutcomeById", "CIS")';
                ShowLoader();
                $.ajax({
                    url:url,
                    method: 'post',
                    data: { Id: id },
                    success: function (data) {
                        HideLoader();
                   
                        $('#txtdesnum').html(dataItem.Qgroup)
                        $('#txtdes').html(dataItem.Qdesc)
                        $('#IsEdit').val(true)
                        $('#Id').val(data.vm.TCFFormId);
                        $('#TCFOutCome_IsEdit').val(true)
                        $('#TCFOutCome_TCFSubOutCome_IsEdit').val(true)
                        $('#TCFOutCome_TCFSubOutCome_Id').val(data.vm.Id)
                        $('#TCFOutCome_TCFSubOutCome_TCFQuestionId').val(data.vm.TCFQuestionId)
                        if (data.vm.RateId != null) {
                            $('#TCFOutCome_TCFSubOutCome_RateId').val(data.vm.RateId.toUpperCase())

                        }
                        if (data.vm.TCFSubOutComeUserId != null)
                        {
                            $('#TCFOutCome_TCFSubOutCome_TCFSubOutComeUserId').val(data.vm.TCFSubOutComeUserId.toUpperCase())

                        }
                        $('#TCFOutCome_TCFSubOutCome_ReasonFully').val(data.vm.ReasonFully)
                        $('#TCFOutCome_TCFSubOutCome_ReasonPartially').val(data.vm.ReasonPartially)
                        $('#TCFOutCome_TCFSubOutCome_ReasonNotApplicable').val(data.vm.ReasonNotApplicable)
                        $('#TCFOutCome_TCFSubOutCome_DueDate').val(data.vm.DueDate)
                        var val = data.vm.RateId.toUpperCase();
                        if (val == 'EE825CC9-466D-44C9-86CF-BBD0C018043C') {
                            $("#notapply").show();
                            $("#notyet").hide();
                            $("#divfully").hide();
                            $("#reguser").hide();
                            $("#dvres").hide();
                        }
                        if (val == '9784C8F8-6BF6-4CA9-BE23-30A11CEC0C76' || val == '329244B5-AF09-4626-B52A-8FFE744BDFF3' || val == '786F9604-13BA-44D9-A878-2CE110FB9E28') {
                            $("#notyet").show();
                            $("#notapply").hide();
                            $("#divfully").hide();
                            $("#reguser").hide();
                            $("#divdate").show();
                            $("#dvres").show();
                        }
                        if (val == '10178C9E-1C8E-47B1-8AC9-4F046160FE2A') {
                            $("#notapply").hide();
                            $("#notyet").hide();
                            $("#divfully").show();
                            $("#responsible").show();
                        }
                        if (val == "") {
                            $("#notyet").hide();
                            $("#divdate").hide();
                            $("#dvres").hide();
                            $("#notapply").hide();


                        }
                        selDiv.empty();
                        table.empty();
                        storedFiles=[];
                        //storedFiles.push(dada._Ev);
                        $.each(data._Ev, function (i, l) {
                            ///var file = new File(l.FileName);
                            
                            var file = new File(["foo"], l.FileName, {
                                type: "text/plain",
                            });
                            storedFiles.push(file)
                        })
                        for (var i = 0, len = storedFiles.length; i < len; i++) {
                            debugger;

                            var image = "<tr><td>" + storedFiles[i].name + "</td><td><input type='button' class='del' data-file='" + storedFiles[i].name + "' id='delete'  value='remove'/></td></tr>";
                            $(table).append(image);
                        }
                       
                        selDiv.append(table);
                    }
                });
              
            });
        });
        function customFunction(value, s) {


            var result = value;

            if (s.sum == 0) {
                result = result + '<span style="position:absolute;right:10px;color:#BA1800;"> Incomplete</span>'
            }
            else {
                result = result + '<span style="position:absolute;right:10px;color:green;"> Complete</span>'
            }
            return result;
        }


    </script>
    <script>
        $(document).ready(function () {
            $("#notapply").hide();
            $("#notyet").hide();
            $("#divfully").hide();
            $("#DueDate").kendoDatePicker();
            $("#divadd").hide();
            $("#divtask").hide();
            $("#reguser").hide();
            $("#responsible").hide();
            $("#TCFOutCome_TCFSubOutCome_DueDate").kendoDatePicker();
            InitFileCloning();
            InitNoteCloning();
            InitTaskCloning();
            $("#divtsk").hide();

            $(".addn").hide();
            $(".addt").hide();
            
        })
    </script>
    <script>
        function SaveTCFResponse(response) {

            if (response.IsSuccess) {
                ShowMessage(response.Message);
                window.location.href = "/Cis/Index/";
            } else {
                ShowMessage(response.Message, "error");
            }
        }
        $("#TCFOutCome_TCFSubOutCome_RateId").on('change', function () {
          
            var val = $(this).val();
            if (val == 'EE825CC9-466D-44C9-86CF-BBD0C018043C') {
                $("#notapply").show();
                $("#notyet").hide();
                $("#divfully").hide();
                $("#reguser").hide();
                $("#dvres").hide();
            }
            if (val == '9784C8F8-6BF6-4CA9-BE23-30A11CEC0C76' || val == '329244B5-AF09-4626-B52A-8FFE744BDFF3' || val == '786F9604-13BA-44D9-A878-2CE110FB9E28') {
                $("#notyet").show();
                $("#notapply").hide();
                $("#divfully").hide();
                $("#reguser").hide();
                $("#divdate").show();
                $("#dvres").show();
            }
            if (val == '10178C9E-1C8E-47B1-8AC9-4F046160FE2A') {
                $("#notapply").hide();
                $("#notyet").hide();
                $("#divfully").show();
                $("#responsible").show();
            }
            if (val=="")
            {
                $("#notyet").hide();
                $("#divdate").hide();
                $("#dvres").hide();
                $("#notapply").hide();
                
               
            }
        })
    </script>
    <script>
        $('#modal').on('show.bs.modal', function () {
            $(this).find('.modal-body').css({
                width: 'auto', //probably not needed
                height: 'auto', //probably not needed
                'max-height': '100%'
            });
        });
    </script>

    <script>
        $(".btnaddnote").on('click', function () {
            $("#divadd").show();
            $(".btnaddnote").hide();
            $(".addn").show();
        })
        $(".addtask").on('click', function () {
            $("#divtsk").show();
            $(".addt").show();
            $(".addtask").hide();
        })
        $(".addn").on('click', function () {
            $(".add-note").click();
            
        })
        $(".addt").on('click', function () {
            
            $(".add-task").click();
        });
        $("#UserId").on('change', function () {
            var value = $("#UserId").val();
            if (value == 0) {
                $("#reguser").show();
            }
            else {
                $("#reguser").hide();
            }

        })


    </script>
<script>
	

	$(document).ready(function() {
		$("#files").on("change", handleFileSelect);

		selDiv = $("#selectedFiles");
		$("#myForm").on("submit", handleForm);


		//$("tblimage").on("click", ".selFile", removeFile);
	});

	function handleFileSelect(e) {
	   
		var files = e.target.files;
		var filesArr = Array.prototype.slice.call(files);
		filesArr.forEach(function(f) {

			if(!f.type.match("image.*")) {
				return;
			}
			storedFiles.push(f);

			var reader = new FileReader();


			reader.onload = function (e) {
			    var image = "<tr><td>" + f.name + "</td><td><input type='button' class='del' data-file='" + f.name + "' id='delete'  value='remove'/></td></tr>";
			    $(table).append(image);
				//var html = "<div><img src=\"" + e.target.result + "\" data-file='"+f.name+"' class='selFile' title='Click to remove'>" + f.name + "<br clear=\"left\"/></div>";


			}
			selDiv.append(table);
			reader.readAsDataURL(f);
			data.append('files',f);
			
		});

	}

	function handleForm(e) {
		e.preventDefault();
		

		var xhr = new XMLHttpRequest();
		xhr.open('POST', 'handler.cfm', true);

		xhr.onload = function(e) {
			if(this.status == 200) {
				console.log(e.currentTarget.responseText);
				alert(e.currentTarget.responseText + ' items uploaded.');
			}
		}

		xhr.send(data);
	}
	$(document).on('click', '.del', function () {
	    
	    var file = $(this).data("file");
	    for (var i = 0; i < storedFiles.length; i++) {
	        if (storedFiles[i].name === file) {
	            debugger;
	            storedFiles.splice(i, 1);
	            break;
	        }
	    }
	    $(this).closest('tr').remove();
	});

</script>

<script>
    $(document).on('click', '.btnupdate', function (e) {
        e.preventDefault();
        var formdata = new FormData($('#frmtcf').get(0));
        for (var i = 0, len = storedFiles.length; i < len; i++) {
            debugger;
            formdata.append("file", storedFiles[i]);
        }
        
        ShowLoader();
        $.ajax({
            type: 'post',
            url: '/CIS/UpdateTCF',
            data: formdata,
            contentType: false,
            cache: false,
            processData: false,
            success: function (response) {
                HideLoader();
                ShowMessage(data.Message);
                $("#frmtcf").trigger("reset");
                $('#EditModal').modal('hide');
                location.reload();
                //$('form')[0].reset();
                // $("#feedback").text(response);

            }
        });

    });
    $(document).on('click', '.btclose', function () {
    
        $("#frmtcf").trigger("reset");
        $('#EditModal').modal('hide');
    })
</script>
}
